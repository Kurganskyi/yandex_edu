# Задания по подзапросам во FROM

## Задание 1

Найдите топ-40 самых длинных фильмов, аренда которых составляет больше 2 долларов. Выведите на экран:
- название фильма — `title`;
- цену аренды — `rental_rate`;
- длительность фильма — `length`;
- возрастной рейтинг — `rating`.

### Решение

```sql
SELECT *
FROM (SELECT title,
             rental_rate,
             length,
             rating
     FROM movie
     WHERE rental_rate > 2
     ORDER BY length DESC
     LIMIT 40) AS m;
```

---

## Задание 2

Используйте запрос из первого задания и проанализируйте данные о возрастных рейтингах отобранных фильмов. Выгрузите в итоговую таблицу следующие поля:
- возрастной рейтинг — `rating`;
- минимальное и максимальное значения длительности фильма — `min_length` и `max_length` соответственно;
- среднее значение длительности фильма — `avg_length`;
- минимум, максимум и среднее для цены просмотра — `min_rental_rate`, `max_rental_rate`, `avg_rental_rate` соответственно.

Отсортируйте среднюю длительность фильма по возрастанию.

### Решение

```sql
SELECT top.rating,
       MIN(top.length) AS min_length,
       MAX(top.length) AS max_length,
       AVG(top.length) AS avg_length,
       MIN(top.rental_rate) AS min_rental_rate,
       MAX(top.rental_rate) AS max_rental_rate,
       AVG(top.rental_rate) AS avg_rental_rate
FROM
  (SELECT title,
          rental_rate,
          length,
          rating
   FROM movie
   WHERE rental_rate > 2
   ORDER BY length DESC
   LIMIT 40) AS top
GROUP BY top.rating
ORDER BY avg_length;
```

---

## Задание 3

Найдите средние значения полей, в которых указаны минимальная и максимальная длительность отобранных фильмов. Отобразите только два этих поля. Назовите их `avg_min_length` и `avg_max_length` соответственно.

### Решение

```sql
SELECT AVG(ratings.min_length) AS avg_min_length,
       AVG(ratings.max_length) AS avg_max_length
FROM
  (SELECT top.rating,
          MIN(top.length) AS min_length,
          MAX(top.length) AS max_length,
          AVG(top.length) AS avg_length,
          MIN(top.rental_rate) AS min_rental_rate,
          MAX(top.rental_rate) AS max_rental_rate,
          AVG(top.rental_rate) AS avg_rental_rate
   FROM
     (SELECT title,
             rental_rate,
             length,
             rating
      FROM movie
      WHERE rental_rate > 2
      ORDER BY length DESC
      LIMIT 40) AS top
   GROUP BY top.rating
   ORDER BY avg_length) AS ratings;
```

---

## Задание 4

Отберите альбомы, названия которых содержат слово 'Rock' и производные от него. В этих альбомах должно быть восемь или более треков. Выведите на экран одно число — среднее количество композиций в отобранных альбомах.

### Решение

```sql
SELECT AVG(rock_albums.track_count) AS avg_track_count
FROM
  (SELECT a.album_id,
          a.title,
          COUNT(t.track_id) AS track_count
   FROM album AS a
   INNER JOIN track AS t ON a.album_id = t.album_id
   WHERE a.title ILIKE '%Rock%'
   GROUP BY a.album_id, a.title
   HAVING COUNT(t.track_id) >= 8) AS rock_albums;
```


5.
Для каждой страны посчитайте среднюю стоимость заказов в 2009 году по месяцам. Отберите данные за 2, 5, 7 и 10-й месяцы и сложите средние значения стоимости заказов. Выведите названия стран, у которых это число превышает 10 долларов.