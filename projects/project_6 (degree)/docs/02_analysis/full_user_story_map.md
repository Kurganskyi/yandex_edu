# Полная карта пользовательских историй (User Story Map)

## Контекст

Полная карта пользовательских историй для приложения Stets Home разработана на основе всех интервью с заказчиком и пользователями. Структура организована по трем базовым активностям с выделением MVP-функций и детальными Gherkin-сценариями.

## Персоны пользователей

### Михаил (Новичок)
- **Возраст:** 30 лет, IT-специалист
- **Опыт:** Новичок в умном доме, боится сложности
- **Цель:** Простое управление освещением, энергосбережение

### Алёна (Эксперт)
- **Возраст:** 35 лет, фитнес-тренер
- **Опыт:** Продвинутый пользователь умного дома
- **Цель:** Автоматизация, удобное управление множеством устройств

---

## АКТИВНОСТЬ 1: Войти в приложение

### Задача 1.1: Пройти регистрацию

#### US-001: Регистрация нового пользователя [MVP]
- **Как** новый пользователь
- **Я хочу** зарегистрироваться в приложении
- **Чтобы** получить доступ к управлению умным домом

**Критерии приемки:**
1. Пользователь может ввести email, пароль и имя
   - **Сценарий:** Успешная регистрация
   - **Пример:** email="mikhail@email.com", пароль="MyPass123", имя="Михаил"
   
2. Система валидирует формат email
   - **Сценарий:** Регистрация с невалидным email
   - **Пример:** email="invalid-email" → ошибка "Неверный формат email"
   
3. Пароль должен содержать 8-16 символов, минимум 1 строчную и 1 прописную букву латиницы
   - **Сценарий:** Регистрация с невалидным паролем
   - **Пример:** пароль="123" → ошибка "Пароль должен содержать 8-16 символов, включая строчные и прописные буквы"
   
4. Email уникален в системе
   - **Сценарий:** Регистрация с существующим email
   - **Пример:** попытка регистрации с email, который уже используется → ошибка "Email уже зарегистрирован"
   
5. После успешной регистрации создается учетная запись
   - **Сценарий:** Успешная регистрация
   - **Пример:** создается учетная запись пользователя в базе данных
   
6. Автоматически создается дом "Мой дом"
   - **Сценарий:** Автосоздание дома при регистрации
   - **Пример:** после регистрации автоматически создается дом с названием "Мой дом"
   
7. Пользователь перенаправляется на главный экран
   - **Сценарий:** Успешная регистрация
   - **Пример:** пользователь попадает на главный экран приложения

**Gherkin-сценарий:**
```gherkin
Scenario: Успешная регистрация
  Given пользователь открыл приложение впервые
  When он нажимает "Зарегистрироваться"
  And вводит валидный email "user@example.com"
  And вводит пароль "Password123"
  And вводит имя "Михаил"
  And нажимает "Создать аккаунт"
  Then создается учетная запись пользователя
  And автоматически создается дом "Мой дом"
  And пользователь попадает на главный экран

Scenario: Регистрация с невалидным паролем
  Given пользователь открыл приложение впервые
  When он вводит пароль "123"
  Then отображается ошибка "Пароль должен содержать 8-16 символов, включая строчные и прописные буквы"

Scenario: Регистрация с существующим email
  Given в системе уже зарегистрирован пользователь с email "existing@example.com"
  When новый пользователь пытается зарегистрироваться с email "existing@example.com"
  Then отображается ошибка "Email уже зарегистрирован"
```

**Примечания:**
- Email используется как логин
- Пароль хэшируется перед сохранением
- Валидация происходит на клиенте и сервере

#### US-002: Автосоздание первого дома [MVP]
- **Как** новый пользователь
- **Я хочу** чтобы первый дом создался автоматически
- **Чтобы** сразу начать добавлять устройства без дополнительных настроек

**Критерии приемки:**
1. Дом создается автоматически после успешной регистрации
   - **Сценарий:** Автосоздание дома при регистрации
   - **Пример:** после регистрации система автоматически создает дом
   
2. Название дома по умолчанию - "Мой дом"
   - **Сценарий:** Автосоздание дома при регистрации
   - **Пример:** созданный дом имеет название "Мой дом"
   
3. Пользователь становится владельцем дома (роль "owner")
   - **Сценарий:** Автосоздание дома при регистрации
   - **Пример:** пользователь получает роль "owner" для созданного дома
   
4. Дом сразу отображается на главном экране
   - **Сценарий:** Автосоздание дома при регистрации
   - **Пример:** после регистрации дом "Мой дом" отображается на главном экране

**Gherkin-сценарий:**
```gherkin
Scenario: Автосоздание дома при регистрации
  Given пользователь успешно зарегистрировался
  When система обрабатывает регистрацию
  Then автоматически создается дом с названием "Мой дом"
  And пользователь становится владельцем этого дома
  And дом отображается на главном экране
```

**Примечания:**
- Это снижает порог входа для новых пользователей
- Название дома можно будет изменить позже
- Поддержка нескольких домов заложена в структуру данных

#### US-003: Вход в приложение [MVP]
- **Как** зарегистрированный пользователь
- **Я хочу** войти в приложение
- **Чтобы** получить доступ к своему умному дому

**Критерии приемки:**
1. Пользователь может войти с email и паролем
   - **Сценарий:** Успешный вход
   - **Пример:** ввод email="mikhail@email.com" и пароль="MyPass123"
   
2. Система проверяет существование пользователя
   - **Сценарий:** Вход с несуществующим email
   - **Пример:** email="wrong@email.com" → ошибка "Неверный email или пароль"
   
3. Система проверяет корректность пароля
   - **Сценарий:** Вход с неверным паролем
   - **Пример:** пароль="wrongpassword" → ошибка "Неверный email или пароль"
   
4. При успешной авторизации создается сессия
   - **Сценарий:** Успешный вход
   - **Пример:** после успешного входа создается сессия пользователя
   
5. Отображается главный экран с домами пользователя
   - **Сценарий:** Успешный вход
   - **Пример:** пользователь видит главный экран со списком своих домов

**Gherkin-сценарий:**
```gherkin
Scenario: Успешный вход
  Given пользователь зарегистрирован в системе
  When он вводит email "user@example.com"
  And вводит пароль "Password123"
  And нажимает "Войти"
  Then пользователь успешно авторизуется
  And отображается главный экран с его домами

Scenario: Вход с неверными данными
  Given пользователь зарегистрирован в системе
  When он вводит неверный email или пароль
  And нажимает "Войти"
  Then отображается ошибка "Неверный email или пароль"
```

**Примечания:**
- Сессия сохраняется для последующих входов
- После 5 неудачных попыток вход блокируется на 15 минут

### Задача 1.2: Управлять учётной записью

#### US-004: Восстановление пароля [MVP]
- **Как** пользователь, забывший пароль
- **Я хочу** восстановить доступ к аккаунту
- **Чтобы** не потерять настройки умного дома

**Критерии приемки:**
1. Пользователь может запросить восстановление пароля
   - **Сценарий:** Восстановление пароля
   - **Пример:** нажатие на кнопку "Забыли пароль?" на экране входа
   
2. Система проверяет существование email в базе
   - **Сценарий:** Восстановление пароля для существующего email
   - **Пример:** email="user@example.com" существует → отправка письма
   
3. На email отправляется уникальная ссылка для сброса
   - **Сценарий:** Восстановление пароля
   - **Пример:** на указанный email отправляется ссылка для сброса пароля
   
4. Ссылка действительна в течение 24 часов
   - **Сценарий:** Использование просроченной ссылки
   - **Пример:** ссылка старше 24 часов → ошибка "Ссылка истекла"
   
5. Пользователь видит подтверждение отправки письма
   - **Сценарий:** Восстановление пароля
   - **Пример:** отображается сообщение "Проверьте почту"
   
6. Возможность установить новый пароль через ссылку
   - **Сценарий:** Установка нового пароля
   - **Пример:** переход по ссылке → экран ввода нового пароля → успешная смена пароля

**Gherkin-сценарий:**
```gherkin
Scenario: Восстановление пароля
  Given пользователь на экране входа
  When он нажимает "Забыли пароль?"
  And вводит email "user@example.com"
  And нажимает "Отправить"
  Then на email отправляется ссылка для сброса пароля
  And отображается сообщение "Проверьте почту"

Scenario: Установка нового пароля
  Given пользователь получил ссылку для сброса пароля
  When он переходит по ссылке
  And вводит новый пароль "NewPassword123"
  And подтверждает пароль "NewPassword123"
  And нажимает "Изменить пароль"
  Then пароль успешно изменяется
  And пользователь может войти с новым паролем
```

**Примечания:**
- Защита от спама: не более 3 запросов в час с одного IP
- Ссылка одноразовая, после использования становится недействительной

#### US-005: Изменение email [MVP]
- **Как** пользователь
- **Я хочу** изменить email в профиле
- **Чтобы** использовать актуальный адрес для уведомлений

**Критерии приемки:**
1. Пользователь может изменить email в настройках
   - **Сценарий:** Изменение email
   - **Пример:** переход в "Профиль" → "Настройки" → "Изменить email"
   
2. Система проверяет валидность формата нового email
   - **Сценарий:** Изменение email на невалидный
   - **Пример:** email="invalid" → ошибка "Неверный формат email"
   
3. Новый email должен быть уникальным в системе
   - **Сценарий:** Изменение email на существующий
   - **Пример:** email="existing@example.com" уже используется → ошибка "Email уже зарегистрирован"
   
4. На новый email отправляется подтверждение
   - **Сценарий:** Изменение email
   - **Пример:** после ввода нового email отправляется письмо с подтверждением
   
5. Старый email остается активным до подтверждения нового
   - **Сценарий:** Изменение email
   - **Пример:** вход возможен со старым email до подтверждения нового

**Gherkin-сценарий:**
```gherkin
Scenario: Изменение email
  Given пользователь авторизован в приложении
  When он переходит в "Профиль" → "Настройки"
  And нажимает "Изменить email"
  And вводит новый email "newemail@example.com"
  And подтверждает изменение
  Then email успешно обновляется
  And на новый email отправляется подтверждение
```

**Примечания:**
- Требуется подтверждение пароля для смены email
- Email используется для входа, важно подтверждение

#### US-006: Выход из приложения [MVP]
- **Как** пользователь
- **Я хочу** выйти из приложения
- **Чтобы** защитить свои данные при использовании чужого устройства

**Критерии приемки:**
1. Пользователь может выйти из аккаунта
   - **Сценарий:** Выход из приложения
   - **Пример:** переход в "Профиль" → нажатие "Выйти"
   
2. Сессия завершается после выхода
   - **Сценарий:** Выход из приложения
   - **Пример:** после выхода сессия пользователя становится недействительной
   
3. Все данные сессии удаляются локально
   - **Сценарий:** Выход из приложения
   - **Пример:** локальные токены и кеш удаляются из устройства
   
4. Отображается экран входа
   - **Сценарий:** Выход из приложения
   - **Пример:** после выхода пользователь видит экран входа
   
5. Для доступа к приложению требуется повторная авторизация
   - **Сценарий:** Выход из приложения
   - **Пример:** попытка открыть приложение требует ввода email и пароля

**Gherkin-сценарий:**
```gherkin
Scenario: Выход из приложения
  Given пользователь авторизован в приложении
  When он переходит в "Профиль"
  And нажимает "Выйти"
  Then пользователь разлогинивается
  And отображается экран входа
```

**Примечания:**
- Все локальные кеши очищаются при выходе
- Токены доступа становятся недействительными

#### US-040: Авторизация через Google [NOT MVP]
- **Как** пользователь
- **Я хочу** войти через аккаунт Google
- **Чтобы** быстро войти без пароля

#### US-041: Авторизация через Яндекс [NOT MVP]
- **Как** пользователь
- **Я хочу** войти через аккаунт Яндекс
- **Чтобы** быстро войти без пароля

---

## АКТИВНОСТЬ 2: Организовать умный дом

### Задача 2.1: Добавить устройство

#### US-010: Добавление устройства через QR-код [MVP]
- **Как** пользователь
- **Я хочу** добавлять устройства сканированием QR-кода
- **Чтобы** быстро подключить новое устройство

**Критерии приемки:**
1. Пользователь может сканировать QR-код для добавления устройства
   - **Сценарий:** Успешное добавление через QR
   - **Пример:** нажатие "Сканировать QR-код" → открытие камеры → сканирование QR-кода
   
2. QR-код содержит 12-значный цифровой код
   - **Сценарий:** Сканирование невалидного QR
   - **Пример:** QR-код с кодом "abc123" → ошибка "Неверный код устройства"
   
3. Система проверяет существование устройства в системе
   - **Сценарий:** Успешное добавление через QR
   - **Пример:** код устройства найден в системе → устройство добавляется
   
4. Максимум 100 устройств на дом
   - **Сценарий:** Превышение лимита устройств
   - **Пример:** попытка добавить 101-е устройство → ошибка "Максимум 100 устройств на дом"
   
5. После добавления предлагается выбрать комнату
   - **Сценарий:** Успешное добавление через QR
   - **Пример:** после сканирования отображается экран выбора комнаты
   
6. Устройство получает название по модели автоматически
   - **Сценарий:** Успешное добавление через QR
   - **Пример:** устройство получает название "Stets Bulb Pro" по модели

**Gherkin-сценарий:**
```gherkin
Scenario: Успешное добавление через QR
  Given пользователь на экране "Добавить устройство"
  When он нажимает "Сканировать QR-код"
  And сканирует валидный QR-код "123456789012"
  Then устройство добавляется в дом
  And отображается в списке устройств
  And предлагается выбрать комнату

Scenario: Сканирование невалидного QR
  Given пользователь сканирует QR-код
  When QR-код содержит невалидный код "abc123"
  Then отображается ошибка "Неверный код устройства"
```

**Примечания:**
- QR-код на упаковке устройства
- Автоматическое определение модели устройства

#### US-011: Добавление устройства вручную [MVP]
- **Как** пользователь
- **Я хочу** добавлять устройства вводом кода вручную
- **Чтобы** подключить устройство когда QR-код поврежден

**Критерии приемки:**
1. Пользователь может ввести 12-значный код вручную
   - **Сценарий:** Добавление устройства вручную
   - **Пример:** ввод кода "123456789012" в поле ввода
   
2. Код валидируется на формат (только цифры, длина 12)
   - **Сценарий:** Ввод невалидного кода
   - **Пример:** код "abc123" → ошибка "Код должен содержать 12 цифр"
   
3. Система проверяет существование устройства
   - **Сценарий:** Добавление устройства вручную
   - **Пример:** код устройства найден в системе → устройство добавляется
   
4. То же поведение что и при QR-сканировании
   - **Сценарий:** Добавление устройства вручную
   - **Пример:** после ввода кода устройство добавляется так же, как при QR-сканировании

**Gherkin-сценарий:**
```gherkin
Scenario: Добавление устройства вручную
  Given пользователь на экране "Добавить устройство"
  When он нажимает "Ввести код вручную"
  And вводит код "123456789012"
  And нажимает "Добавить"
  Then устройство добавляется в дом
  And отображается в списке устройств
```

**Примечания:**
- Код на упаковке устройства
- Важная функция для поврежденных QR-кодов

#### US-012: Предотвращение дубликатов устройств [MVP]
- **Как** пользователь
- **Я хочу** чтобы система предотвращала добавление одного устройства дважды
- **Чтобы** избежать путаницы в управлении

**Критерии приемки:**
1. Система проверяет уникальность кода устройства в доме
   - **Сценарий:** Попытка добавить существующее устройство
   - **Пример:** устройство с кодом "123456789012" уже добавлено → проверка выполняется
   
2. Попытка добавить существующее устройство блокируется
   - **Сценарий:** Попытка добавить существующее устройство
   - **Пример:** устройство не добавляется повторно
   
3. Отображается понятное сообщение об ошибке
   - **Сценарий:** Попытка добавить существующее устройство
   - **Пример:** ошибка "Устройство уже добавлено в дом"
   
4. Дубликаты не создаются
   - **Сценарий:** Попытка добавить существующее устройство
   - **Пример:** в базе данных остается только одно устройство с данным кодом

**Gherkin-сценарий:**
```gherkin
Scenario: Попытка добавить существующее устройство
  Given устройство с кодом "123456789012" уже добавлено
  When пользователь пытается добавить устройство с тем же кодом
  Then отображается ошибка "Устройство уже добавлено в дом"
  And устройство не добавляется повторно
```

**Примечания:**
- Критично для пользователей
- Проверка на уровне кода устройства

### Задача 2.2: Настроить устройство

#### US-013: Привязка устройства к комнате [MVP]
- **Как** пользователь
- **Я хочу** привязывать устройства к комнатам
- **Чтобы** организовать управление по помещениям

**Критерии приемки:**
1. Устройство можно привязать к комнате
   - **Сценарий:** Привязка устройства к комнате
   - **Пример:** выбор устройства → "Настроить устройство" → выбор комнаты
   
2. Выбор из списка существующих комнат
   - **Сценарий:** Привязка устройства к комнате
   - **Пример:** отображается список комнат дома для выбора
   
3. Привязка опциональна (можно оставить без комнаты)
   - **Сценарий:** Привязка устройства к комнате
   - **Пример:** возможность выбрать "Без комнаты" или пропустить шаг
   
4. Устройство отображается в комнате после привязки
   - **Сценарий:** Привязка устройства к комнате
   - **Пример:** устройство появляется в списке устройств выбранной комнаты

**Gherkin-сценарий:**
```gherkin
Scenario: Привязка устройства к комнате
  Given устройство добавлено в дом
  When пользователь выбирает "Настроить устройство"
  And выбирает комнату "Спальня"
  And нажимает "Сохранить"
  Then устройство привязывается к комнате
  And отображается в списке устройств комнаты
```

**Примечания:**
- Комнаты не обязательны для работы с приложением
- Можно добавлять устройства до создания комнат

#### US-014: Удаление устройства [MVP]
- **Как** пользователь
- **Я хочу** удалять сломанные устройства
- **Чтобы** поддерживать актуальный список устройств

**Критерии приемки:**
1. Устройство можно удалить из дома
   - **Сценарий:** Удаление устройства
   - **Пример:** выбор устройства → "Удалить устройство"
   
2. Требуется подтверждение удаления
   - **Сценарий:** Удаление устройства
   - **Пример:** отображается диалог подтверждения "Вы уверены?"
   
3. Устройство удаляется из всех комнат
   - **Сценарий:** Удаление устройства
   - **Пример:** после удаления устройство исчезает из всех комнат
   
4. После удаления устройство больше не отображается
   - **Сценарий:** Удаление устройства
   - **Пример:** устройство не видно в списке устройств дома

**Gherkin-сценарий:**
```gherkin
Scenario: Удаление устройства
  Given устройство "Лампочка в спальне" добавлено
  When пользователь выбирает "Удалить устройство"
  And подтверждает удаление
  Then устройство удаляется из дома
  And больше не отображается в списке
```

**Примечания:**
- Защита от случайного удаления
- Все настройки устройства теряются при удалении

#### US-043: Изменение названия устройства [NOT MVP]
- **Как** пользователь
- **Я хочу** изменять названия устройств
- **Чтобы** называть их по-своему

#### US-044: Удаление устройства из комнаты [MVP]
- **Как** пользователь
- **Я хочу** удалять устройство из комнаты
- **Чтобы** переместить его в другую комнату

**Критерии приемки:**
1. Устройство можно убрать из комнаты без удаления из дома
   - **Сценарий:** Удаление устройства из комнаты
   - **Пример:** выбор устройства в комнате → "Удалить из комнаты"
   
2. После удаления устройство остается в доме
   - **Сценарий:** Удаление устройства из комнаты
   - **Пример:** устройство остается в списке "Мои устройства"
   
3. Устройство можно потом привязать к другой комнате
   - **Сценарий:** Перемещение устройства
   - **Пример:** удаление из "Спальни" → привязка к "Гостиной"
   
4. Требуется подтверждение действия
   - **Сценарий:** Удаление устройства из комнаты
   - **Пример:** отображается подтверждение перед удалением

**Gherkin-сценарий:**
```gherkin
Scenario: Удаление устройства из комнаты
  Given устройство "Лампочка" привязано к комнате "Спальня"
  When пользователь выбирает "Удалить из комнаты"
  And подтверждает действие
  Then устройство удаляется из комнаты
  And остается в доме без привязки к комнате
```

**Примечания:**
- Полезно при переездах и перестановках
- Альтернатива прямому изменению комнаты

### Задача 2.3: Добавить комнату

#### US-007: Создание комнат [MVP]
- **Как** пользователь
- **Я хочу** создавать комнаты в доме
- **Чтобы** организовать устройства по помещениям

**Критерии приемки:**
1. Пользователь может создать комнату с типом, названием и иконкой
   - **Сценарий:** Создание новой комнаты
   - **Пример:** нажатие "Добавить комнату" → выбор типа "Спальня" → ввод названия "Главная спальня"
   
2. Максимум 10 комнат на дом
   - **Сценарий:** Превышение лимита комнат
   - **Пример:** попытка создать 11-ю комнату → ошибка "Максимум 10 комнат на дом"
   
3. Название комнаты обязательно для заполнения
   - **Сценарий:** Создание комнаты без названия
   - **Пример:** попытка создать комнату без названия → ошибка "Название обязательно"
   
4. Доступны типы: living_room, bedroom, kitchen, bathroom, hallway, corridor, other
   - **Сценарий:** Создание новой комнаты
   - **Пример:** выбор из списка типов комнат
   
5. Выбор иконки из предустановленного набора
   - **Сценарий:** Создание новой комнаты
   - **Пример:** выбор иконки "кровать" для спальни
   
6. Комната появляется на главном экране
   - **Сценарий:** Создание новой комнаты
   - **Пример:** созданная комната отображается в списке комнат на главном экране

**Gherkin-сценарий:**
```gherkin
Scenario: Создание новой комнаты
  Given пользователь на главном экране дома
  When он нажимает "Добавить комнату"
  And выбирает тип "Спальня"
  And вводит название "Главная спальня"
  And выбирает иконку "кровать"
  And нажимает "Создать"
  Then комната добавляется в список
  And отображается на главном экране

Scenario: Превышение лимита комнат
  Given в доме уже 10 комнат
  When пользователь пытается добавить 11-ю комнату
  Then отображается ошибка "Максимум 10 комнат на дом"
```

**Примечания:**
- Комнаты не обязательны - можно работать без них
- Комнаты можно создавать до или после добавления устройств

#### US-008: Редактирование комнат [MVP]
- **Как** пользователь
- **Я хочу** изменять данные комнат
- **Чтобы** исправить ошибки или обновить информацию

**Критерии приемки:**
1. Пользователь может изменить название, тип и иконку комнаты
   - **Сценарий:** Редактирование комнаты
   - **Пример:** выбор комнаты → "Редактировать" → изменение названия
   
2. Изменения сохраняются в базе данных
   - **Сценарий:** Редактирование комнаты
   - **Пример:** нажатие "Сохранить" → изменения сохраняются
   
3. Обновленная информация отображается немедленно
   - **Сценарий:** Редактирование комнаты
   - **Пример:** после сохранения комната отображается с новыми данными
   
4. Устройства в комнате не затронуты изменениями
   - **Сценарий:** Редактирование комнаты
   - **Пример:** устройства остаются в комнате после изменения её названия

**Gherkin-сценарий:**
```gherkin
Scenario: Редактирование комнаты
  Given пользователь видит список комнат
  When он нажимает на комнату "Спальня"
  And выбирает "Редактировать"
  And изменяет название на "Главная спальня"
  And изменяет тип на "Гостиная"
  And нажимает "Сохранить"
  Then изменения сохраняются
  And комната отображается с новыми данными
```

**Примечания:**
- Все поля можно редактировать
- Требуется подтверждение сохранения

#### US-009: Удаление комнат [MVP]
- **Как** пользователь
- **Я хочу** удалять ненужные комнаты
- **Чтобы** поддерживать актуальную структуру дома

**Критерии приемки:**
1. Пустая комната удаляется без предупреждения
   - **Сценарий:** Удаление пустой комнаты
   - **Пример:** комната без устройств → удаление без предупреждения
   
2. Комната с устройствами требует предупреждение
   - **Сценарий:** Удаление комнаты с устройствами
   - **Пример:** попытка удалить комнату с устройствами → предупреждение
   
3. Пользователь не может удалить комнату с устройствами
   - **Сценарий:** Удаление комнаты с устройствами
   - **Пример:** удаление блокируется при наличии устройств
   
4. Удаление требует подтверждения
   - **Сценарий:** Удаление пустой комнаты
   - **Пример:** отображение диалога подтверждения перед удалением

**Gherkin-сценарий:**
```gherkin
Scenario: Удаление пустой комнаты
  Given комната "Коридор" не содержит устройств
  When пользователь выбирает "Удалить комнату"
  And подтверждает удаление
  Then комната удаляется из списка

Scenario: Удаление комнаты с устройствами
  Given комната "Спальня" содержит устройства
  When пользователь пытается удалить комнату
  Then отображается предупреждение "В комнате есть устройства. Сначала переместите их в другие комнаты"
```

**Примечания:**
- Защита от случайного удаления
- Требуется явное подтверждение

#### US-042: Переключение между домами [MVP]
- **Как** пользователь с несколькими домами
- **Я хочу** переключаться между домами
- **Чтобы** управлять разными умными домами

**Критерии приемки:**
1. Пользователь может переключаться между своими домами
   - **Сценарий:** Переключение между домами
   - **Пример:** нажатие на название текущего дома → выбор другого дома
   
2. Максимум 10 домов на пользователя
   - **Сценарий:** Переключение между домами
   - **Пример:** отображается список всех домов пользователя (до 10)
   
3. Отображается текущий активный дом в заголовке
   - **Сценарий:** Переключение между домами
   - **Пример:** название активного дома отображается в заголовке экрана
   
4. При переключении обновляются комнаты и устройства
   - **Сценарий:** Переключение между домами
   - **Пример:** после переключения отображаются комнаты и устройства выбранного дома

**Gherkin-сценарий:**
```gherkin
Scenario: Переключение между домами
  Given пользователь владеет 2 домами
  When он нажимает на название текущего дома
  And выбирает другой дом из списка
  Then отображается интерфейс выбранного дома
  And список комнат и устройств обновляется
```

**Примечания:**
- Первый дом создается автоматически при регистрации
- Дополнительные дома создаются вручную (не в MVP)

---

## АКТИВНОСТЬ 3: Управлять умным домом

### Задача 3.1: Управлять устройством

#### US-015: Включение/выключение устройства [MVP]
- **Как** пользователь
- **Я хочу** включать и выключать устройства
- **Чтобы** управлять освещением и другими приборами

**Критерии приемки:**
1. Пользователь может включать и выключать устройство одним нажатием
   - **Сценарий:** Включение устройства
   - **Пример:** нажатие переключателя → устройство включается
   
2. Статус устройства синхронизируется с физическим состоянием
   - **Сценарий:** Включение устройства
   - **Пример:** после включения физическое устройство включается
   
3. Время отклика устройства < 2 секунд
   - **Сценарий:** Включение устройства
   - **Пример:** устройство реагирует на команду в течение 2 секунд
   
4. Статус "недоступно" если устройство не отвечает
   - **Сценарий:** Устройство недоступно
   - **Пример:** устройство не отвечает → отображение статуса "недоступно"
   
5. Отображается визуальный индикатор статуса
   - **Сценарий:** Включение устройства
   - **Пример:** изменение цвета индикатора при изменении статуса

**Gherkin-сценарий:**
```gherkin
Scenario: Включение устройства
  Given устройство "Лампочка" выключено
  When пользователь нажимает переключатель устройства
  Then устройство включается
  And статус изменяется на "включено"
  And устройство физически включается

Scenario: Выключение устройства
  Given устройство "Лампочка" включено
  When пользователь нажимает переключатель устройства
  Then устройство выключается
  And статус изменяется на "выключено"
```

**Примечания:**
- Обновление статуса в реальном времени
- Поддержка офлайн режима (статус обновится при подключении)

#### US-016: Управление режимом энергосбережения [MVP]
- **Как** пользователь
- **Я хочу** включать режим энергосбережения
- **Чтобы** экономить электроэнергию

**Критерии приемки:**
1. Пользователь может включить/выключить энергосбережение
   - **Сценарий:** Включение энергосбережения
   - **Пример:** нажатие "Энергосбережение" → режим активируется
   
2. Режим доступен только для включенных устройств
   - **Сценарий:** Попытка включить энергосбережение на выключенном устройстве
   - **Пример:** устройство выключено → ошибка "Сначала включите устройство"
   
3. При энергосбережении потребление снижается
   - **Сценарий:** Включение энергосбережения
   - **Пример:** устройство потребляет меньше энергии в режиме энергосбережения
   
4. Время отклика увеличивается до 5 секунд
   - **Сценарий:** Включение энергосбережения
   - **Пример:** устройство реагирует на команды в течение 5 секунд
   
5. Визуально отображается активный режим
   - **Сценарий:** Включение энергосбережения
   - **Пример:** индикатор режима энергосбережения активен

**Gherkin-сценарий:**
```gherkin
Scenario: Включение энергосбережения
  Given устройство "Лампочка" включено
  When пользователь нажимает "Энергосбережение"
  Then режим энергосбережения активируется
  And устройство потребляет меньше энергии
  And время отклика увеличивается

Scenario: Отключение энергосбережения
  Given устройство в режиме энергосбережения
  When пользователь отключает режим
  Then устройство возвращается к обычному режиму
  And время отклика уменьшается
```

**Примечания:**
- Уникальная функция Stets - конкурентное преимущество
- Устройство оптимизирует вспомогательные процессы
- Некоторые пользователи могут не любить увеличенное время отклика

#### US-017: Управление всеми устройствами комнаты [MVP]
- **Как** пользователь
- **Я хочу** управлять всеми устройствами в комнате одной кнопкой
- **Чтобы** быстро включать/выключать освещение в помещении

**Критерии приемки:**
1. Одна кнопка управляет всеми устройствами в комнате
   - **Сценарий:** Включение всех устройств в комнате
   - **Пример:** нажатие "Включить все в комнате" → все устройства включаются
   
2. Действие применяется ко всем устройствам одновременно
   - **Сценарий:** Включение всех устройств в комнате
   - **Пример:** все устройства в комнате получают команду одновременно
   
3. Статусы всех устройств обновляются
   - **Сценарий:** Включение всех устройств в комнате
   - **Пример:** статус всех устройств изменяется на "включено"
   
4. Работает только для устройств в комнате
   - **Сценарий:** Включение всех устройств в комнате
   - **Пример:** устройства не в комнате не затронуты

**Gherkin-сценарий:**
```gherkin
Scenario: Включение всех устройств в комнате
  Given в комнате "Спальня" 3 устройства (2 включены, 1 выключено)
  When пользователь нажимает "Включить все в комнате"
  Then все устройства в комнате включаются
  And статус всех устройств изменяется на "включено"

Scenario: Выключение всех устройств в комнате
  Given в комнате "Спальня" все устройства включены
  When пользователь нажимает "Выключить все в комнате"
  Then все устройства в комнате выключаются
```

**Примечания:**
- Удобно для быстрого управления освещением в комнате
- Не влияет на устройства не в комнате

#### US-045: Настройка яркости устройства [NOT MVP]
- **Как** пользователь
- **Я хочу** настраивать яркость лампочки
- **Чтобы** создавать комфортное освещение

#### US-046: Изменение цвета устройства [NOT MVP]
- **Как** пользователь
- **Я хочу** изменять цвет лампочки
- **Чтобы** создавать атмосферу или экспериментировать

### Задача 3.2: Управлять комнатой

#### US-007: Создание комнат [MVP]
- (См. Задача 2.3: Добавить комнату)

#### US-008: Редактирование комнат [MVP]
- (См. Задача 2.3: Добавить комнату)

#### US-009: Удаление комнат [MVP]
- (См. Задача 2.3: Добавить комнату)

#### US-017: Управление всеми устройствами комнаты [MVP]
- (См. Задача 3.1: Управлять устройством)

### Задача 3.3: Управлять автоматизацией

#### US-018: Создание сценария [MVP]
- **Как** пользователь
- **Я хочу** создавать сценарии автоматизации
- **Чтобы** автоматизировать управление устройствами

**Критерии приемки:**
1. Пользователь может создать сценарий с названием
   - **Сценарий:** Создание сценария "Утро"
   - **Пример:** ввод названия "Утренний свет"
   
2. Можно добавить несколько устройств в сценарий
   - **Сценарий:** Создание сценария "Утро"
   - **Пример:** выбор устройств "Лампочка в спальне", "Лампочка в ванной"
   
3. Для каждого устройства выбирается действие (включить/выключить)
   - **Сценарий:** Создание сценария "Утро"
   - **Пример:** установка действия "включить" для всех устройств
   
4. Максимум 10 сценариев на дом
   - **Сценарий:** Превышение лимита сценариев
   - **Пример:** попытка создать 11-й сценарий → ошибка "Максимум 10 сценариев на дом"
   
5. Название сценария до 30 символов
   - **Сценарий:** Создание сценария с длинным названием
   - **Пример:** название > 30 символов → ошибка "Название должно быть не более 30 символов"
   
6. Сценарий отображается в списке сценариев
   - **Сценарий:** Создание сценария "Утро"
   - **Пример:** созданный сценарий появляется в списке сценариев

**Gherkin-сценарий:**
```gherkin
Scenario: Создание сценария "Утро"
  Given пользователь на экране "Сценарии"
  When он нажимает "Создать сценарий"
  And вводит название "Утренний свет"
  And выбирает устройства "Лампочка в спальне", "Лампочка в ванной"
  And устанавливает действие "включить" для всех устройств
  And нажимает "Сохранить"
  Then сценарий создается
  And отображается в списке сценариев

Scenario: Превышение лимита сценариев
  Given в доме уже 10 сценариев
  When пользователь пытается создать 11-й сценарий
  Then отображается ошибка "Максимум 10 сценариев на дом"
```

**Примечания:**
- Критичная функция для продвинутых пользователей
- Сценарии - ключевое конкурентное преимущество

#### US-019: Ручной запуск сценария [MVP]
- **Как** пользователь
- **Я хочу** запускать сценарии вручную
- **Чтобы** быстро выполнить набор действий

**Критерии приемки:**
1. Пользователь может запустить сценарий вручную кнопкой
   - **Сценарий:** Ручной запуск сценария
   - **Пример:** нажатие кнопки запуска на карточке сценария
   
2. Все устройства в сценарии выполняют действия
   - **Сценарий:** Ручной запуск сценария
   - **Пример:** все устройства в сценарии включаются/выключаются
   
3. Отображается статус выполнения сценария
   - **Сценарий:** Ручной запуск сценария
   - **Пример:** отображение статуса "Сценарий выполнен"
   
4. Если устройство недоступно, остальные выполняются
   - **Сценарий:** Ручной запуск сценария с недоступным устройством
   - **Пример:** недоступное устройство пропускается, остальные выполняются
   
5. Действия выполняются в порядке execution_order
   - **Сценарий:** Ручной запуск сценария
   - **Пример:** действия выполняются последовательно согласно порядку

**Gherkin-сценарий:**
```gherkin
Scenario: Ручной запуск сценария
  Given сценарий "Утренний свет" создан
  When пользователь нажимает кнопку запуска сценария
  Then все устройства в сценарии включаются
  And отображается статус "Сценарий выполнен"
```

**Примечания:**
- Кнопка запуска на главном экране сценариев
- Удобно для быстрого управления

#### US-020: Настройка расписания сценария [MVP]
- **Как** пользователь
- **Я хочу** настраивать автоматический запуск сценариев
- **Чтобы** устройства работали по расписанию

**Критерии приемки:**
1. Можно выбрать дни недели для запуска
   - **Сценарий:** Настройка расписания
   - **Пример:** выбор дней "Понедельник, Вторник, Среда, Четверг, Пятница"
   
2. Можно установить время запуска сценария
   - **Сценарий:** Настройка расписания
   - **Пример:** установка времени "07:00"
   
3. Можно установить время окончания сценария
   - **Сценарий:** Настройка расписания
   - **Пример:** установка времени окончания "08:00"
   
4. Если время не указано, только ручной запуск
   - **Сценарий:** Создание сценария без расписания
   - **Пример:** сценарий доступен только для ручного запуска
   
5. Время окончания опционально
   - **Сценарий:** Настройка расписания без времени окончания
   - **Пример:** можно настроить только время запуска
   
6. Сценарий запускается автоматически по расписанию
   - **Сценарий:** Автоматический запуск сценария
   - **Пример:** сценарий запускается в 7:00 в выбранные дни

**Gherkin-сценарий:**
```gherkin
Scenario: Настройка расписания
  Given сценарий "Утренний свет" создан
  When пользователь выбирает "Настроить расписание"
  And выбирает дни "Понедельник, Вторник, Среда, Четверг, Пятница"
  And устанавливает время "07:00"
  And устанавливает время окончания "08:00"
  And нажимает "Сохранить"
  Then сценарий будет запускаться автоматически в будни в 7:00
  And устройства будут выключаться в 8:00
```

**Примечания:**
- Пошаговая настройка расписания
- Время окончания - востребованная функция по данным заказчика

#### US-021: Удаление сценария [MVP]
- **Как** пользователь
- **Я хочу** удалять ненужные сценарии
- **Чтобы** поддерживать актуальный список автоматизации

**Критерии приемки:**
1. Сценарий можно удалить из списка
   - **Сценарий:** Удаление сценария
   - **Пример:** выбор сценария → "Удалить сценарий"
   
2. Требуется подтверждение удаления
   - **Сценарий:** Удаление сценария
   - **Пример:** отображение диалога подтверждения
   
3. После удаления сценарий не запускается автоматически
   - **Сценарий:** Удаление сценария
   - **Пример:** автоматический запуск прекращается после удаления
   
4. История выполнения сохраняется (если требуется)
   - **Сценарий:** Удаление сценария
   - **Пример:** история выполнения сценария сохраняется в базе данных

**Gherkin-сценарий:**
```gherkin
Scenario: Удаление сценария
  Given сценарий "Старый сценарий" существует
  When пользователь выбирает "Удалить сценарий"
  And подтверждает удаление
  Then сценарий удаляется
  And больше не отображается в списке
```

**Примечания:**
- Защита от случайного удаления

#### US-048: Редактирование сценария [NOT MVP]
- **Как** пользователь
- **Я хочу** редактировать существующий сценарий
- **Чтобы** изменять действия и расписание

#### US-049: Создание сценария по таймеру [NOT MVP]
- **Как** пользователь
- **Я хочу** создавать сценарии с таймером
- **Чтобы** отключать устройства через заданное время

---

## Итоговая статистика

### MVP (MUST HAVE)
- **Всего историй:** 22
- **Все с Gherkin-сценариями**
- **Все с критериями приемки, примерами и примечаниями**

### Будущие версии (SHOULD HAVE / COULD HAVE)
- **Всего историй:** 15
- **Без Gherkin-сценариев** (пока не в разработке)

### Общая статистика
- **Всего пользовательских историй:** 37
- **Активностей:** 3
- **Пользовательских задач:** 8
- **Gherkin-сценариев для MVP:** 60+

### Детализация MVP историй
- **Войти в приложение:** 6 историй
- **Организовать умный дом:** 9 историй
- **Управлять умным домом:** 7 историй

---

## Критерии готовности (Definition of Done)

Для каждой пользовательской истории MVP:
1. ✅ Функциональность реализована согласно Gherkin-сценариям
2. ✅ Все сценарии проходят автоматические тесты
3. ✅ UI соответствует дизайн-системе Stets
4. ✅ Обработаны все edge cases и ошибки
5. ✅ Функция протестирована на обеих персонах (Михаил и Алёна)
6. ✅ Производительность соответствует требованиям (< 2 сек отклик)
7. ✅ Документация обновлена

---

## Метрики успеха MVP

- **Время онбординга:** < 5 минут от установки до первого управляемого устройства
- **Успешность добавления устройства:** > 95% через QR-код, > 90% через ручной ввод
- **Время отклика устройства:** < 2 секунды в обычном режиме, < 5 секунд в энергосбережении
- **Удовлетворенность пользователей:** > 4.0/5.0 в опросе после использования MVP

---

*Документ включает все пользовательские истории, определенные на основе интервью с заказчиком и пользователями, с четким разделением на MVP и будущие версии. Структура организована по трем базовым активностям согласно требованиям ревьюера.*
