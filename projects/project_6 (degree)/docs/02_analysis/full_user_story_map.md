# Полная карта пользовательских историй (User Story Map)

## Контекст

Полная карта пользовательских историй для приложения Stets Home разработана на основе всех интервью с заказчиком и пользователями. Структура организована по трем базовым активностям («Войти в приложение» → «Организовать умный дом» → «Управлять умным домом»), каждая история содержит явные критерии приемки и связанные Gherkin-сценарии/примеры для каждого критерия.

## Персоны пользователей

### Михаил (Новичок)
- **Возраст:** 30 лет, IT-специалист
- **Опыт:** Новичок в умном доме, боится сложности
- **Цель:** Простое управление освещением, энергосбережение

### Алёна (Эксперт)
- **Возраст:** 35 лет, фитнес-тренер
- **Опыт:** Продвинутый пользователь умного дома
- **Цель:** Автоматизация, удобное управление множеством устройств

---

## АКТИВНОСТЬ 1: Войти в приложение

### Задача 1.1: Пройти регистрацию

#### US-001: Регистрация нового пользователя [MVP]

**Примечание:** Email используется как логин; пароль хэшируется перед сохранением и проверяется на клиенте и сервере.

**Критерии приемки:**
- Пользователь может указать email, пароль и имя для регистрации.
- Формат email валидируется.
- Пароль содержит 8–16 символов и минимум по одной строчной и прописной латинской букве.
- Email уникален в системе.
- После успешной регистрации создаётся учётная запись, автоматически создаётся дом «Мой дом», пользователь перенаправляется на главный экран.

**Сценарий 1: Успешная регистрация**  
_Дано_ пользователь впервые открыл приложение.  
_Когда_ он нажимает «Зарегистрироваться», вводит валидные email, пароль и имя и отправляет форму.  
_Тогда_ создаётся его учётная запись, автоматически появляется дом «Мой дом», пользователь попадает на главный экран.

**Сценарий 2: Невалидный email**  
_Дано_ пользователь на экране регистрации.  
_Когда_ он вводит email в неверном формате.  
_Тогда_ система показывает сообщение «Неверный формат email».

**Сценарий 3: Невалидный пароль**  
_Дано_ пользователь на экране регистрации.  
_Когда_ он вводит пароль, не соответствующий требованиям по длине и регистру.  
_Тогда_ система показывает сообщение «Пароль должен содержать 8–16 символов, включая строчные и прописные буквы».

**Сценарий 4: Дубликат email**  
_Дано_ в системе уже существует пользователь с указанным email.  
_Когда_ новый пользователь пытается завершить регистрацию с тем же email.  
_Тогда_ система показывает сообщение «Email уже зарегистрирован».

**Структура сценария:**  
1. Пользователь открывает экран регистрации.  
2. Заполняет обязательные поля (email, пароль, имя).  
3. Отправляет форму.  
4. Система валидирует данные и создаёт учётную запись либо показывает ошибку.  
5. При успехе автоматически создаётся дом «Мой дом», пользователь перенаправляется на главный экран.

**Примеры:**  
| email | пароль | имя | результат |  
| --- | --- | --- | --- |  
| `mikhail@email.com` | `MyPass123` | `Михаил` | Регистрация успешна, создан дом «Мой дом» |  
| `invalid-email` | `MyPass123` | `Михаил` | Ошибка: «Неверный формат email» |  
| `mikhail@email.com` | `123` | `Михаил` | Ошибка: «Пароль должен содержать 8–16 символов…» |  
| `existing@email.com` | `MyPass123` | `Антон` | Ошибка: «Email уже зарегистрирован» |

#### US-002: Автосоздание первого дома [MVP]

**Примечание:** Автоматический дом снижает порог входа. Название «Мой дом» можно изменить позже; архитектура поддерживает несколько домов.

**Критерии приемки:**
- После успешной регистрации у пользователя автоматически создаётся первый дом.
- Дом получает название «Мой дом».
- Пользователь становится владельцем (role = owner).
- Дом сразу отображается на главном экране.

**Сценарий:**  
_Дано_ пользователь успешно завершил регистрацию.  
_Когда_ система сохраняет новую учётную запись.  
_Тогда_ автоматически создаётся дом «Мой дом», пользователю присваивается роль владельца, дом отображается на главном экране.

**Структура сценария:**  
1. Регистрация завершается успешно.  
2. Бэкенд создаёт запись дома с названием «Мой дом».  
3. Пользователь связывается с домом в роли владельца.  
4. Клиент обновляет главный экран и показывает дом.

**Примеры:**  
| Пользователь | Результат |  
| --- | --- |  
| `user@example.com` | Создан дом «Мой дом», роль владельца, дом виден на Dashboard |  
| любой новый аккаунт | Дом создаётся автоматически с теми же параметрами |

#### US-003: Вход в приложение [MVP]

**Примечание:** Сессия сохраняется для последующих входов; после 5 неудачных попыток вход блокируется на 15 минут.

**Критерии приемки:**
- Пользователь входит по email и паролю.
- Система проверяет наличие пользователя и корректность пароля.
- При успешной авторизации создаётся сессия и открывается главный экран с домами пользователя.
- При неверных данных показывается ошибка «Неверный email или пароль».

**Сценарий 1: Успешный вход**  
_Дано_ пользователь зарегистрирован.  
_Когда_ он вводит корректный email и пароль и нажимает «Войти».  
_Тогда_ создаётся сессия пользователя и отображается главный экран с его домами.

**Сценарий 2: Вход с неверными данными**  
_Дано_ пользователь пытается войти в систему.  
_Когда_ он вводит неверный email или пароль.  
_Тогда_ система показывает сообщение «Неверный email или пароль» и не авторизует пользователя.

**Структура сценария:**  
1. Пользователь открывает экран входа.  
2. Заполняет поля email и пароль.  
3. Отправляет форму.  
4. Бэкенд проверяет существование пользователя и пароль.  
5. В зависимости от результата либо создаёт сессию и возвращает данные, либо выдаёт ошибку.

**Примеры:**  
| email | пароль | результат |  
| --- | --- | --- |  
| `user@example.com` | `Password123` | Успешный вход, открыт Dashboard |  
| `wrong@example.com` | `Password123` | Ошибка: «Неверный email или пароль» |  
| `user@example.com` | `wrongpass` | Ошибка: «Неверный email или пароль» |

### Задача 1.2: Управлять учётной записью

#### US-004: Восстановление пароля [MVP]

**Примечание:** Не более 3 запросов восстановления в час с одного IP; ссылка одноразовая и действует 24 часа.

**Критерии приемки:**
- Пользователь может запросить восстановление через ссылку «Забыли пароль?».
- Если email существует, система отправляет письмо со ссылкой.
- Ссылка активна 24 часа; при истечении срока выводится ошибка.
- Пользователь видит подтверждение отправки письма.
- По ссылке можно задать новый пароль, после чего можно войти в систему.

**Сценарий 1: Запрос восстановления**  
_Дано_ пользователь на экране входа.  
_Когда_ он нажимает «Забыли пароль?», вводит email и отправляет форму.  
_Тогда_ при существующем email система отправляет письмо со ссылкой, отображает сообщение «Проверьте почту».

**Сценарий 2: Просроченная ссылка**  
_Дано_ пользователь открыл ссылку восстановления позже 24 часов.  
_Когда_ он пытается ввести новый пароль.  
_Тогда_ система сообщает «Ссылка истекла» и не меняет пароль.

**Сценарий 3: Смена пароля**  
_Дано_ пользователь открыл актуальную ссылку.  
_Когда_ он вводит и подтверждает новый пароль и отправляет форму.  
_Тогда_ пароль обновляется, пользователь может войти в систему с новым значением.

**Структура сценария:**  
1. Пользователь инициирует восстановление.  
2. Система валидирует email и, при наличии, отправляет письмо с одноразовой ссылкой.  
3. Пользователь переходит по ссылке, вводит новый пароль, подтверждает.  
4. Система проверяет валидность ссылки, обновляет пароль и сообщает об успехе.

**Примеры:**  
| email | результат |  
| --- | --- |  
| `user@example.com` | Отправлено письмо, пользователь видит «Проверьте почту» |  
| `user@example.com` (через 25 часов) | Ошибка «Ссылка истекла» |  
| `user@example.com` (валидная ссылка) | Пароль изменён, можно войти |

#### US-005: Изменение email [MVP]

**Примечание:** Для смены email требуется повторно ввести пароль; пока новый email не подтверждён, вход доступен по старому адресу.

**Критерии приемки:**
- На экране профиля доступно изменение email.
- Формат нового email валидируется.
- Новый email должен быть уникальным.
- На новый email отправляется письмо с подтверждением.
- Старый email остаётся активным до подтверждения.

**Сценарий 1: Успешное изменение**  
_Дано_ пользователь авторизован и открыл профиль.  
_Когда_ он выбирает «Изменить email», вводит новый email, подтверждает пароль и отправляет форму.  
_Тогда_ система сохраняет новый email в статусе «ожидает подтверждения» и отправляет письмо.

**Сценарий 2: Невалидный email**  
_Дано_ пользователь на форме изменения email.  
_Когда_ он вводит email в неверном формате.  
_Тогда_ система выводит сообщение «Неверный формат email», изменения не сохраняются.

**Сценарий 3: Email уже используется**  
_Дано_ в системе уже есть пользователь с введённым email.  
_Когда_ пользователь пытается сохранить этот email.  
_Тогда_ отображается сообщение «Email уже зарегистрирован».

**Структура сценария:**  
1. Пользователь инициирует изменение email из профиля.  
2. Вводит новый email и подтверждает пароль.  
3. Система валидирует формат и уникальность.  
4. При успехе отправляет письмо и сохраняет новый email после подтверждения.

**Примеры:**  
| старый email | новый email | результат |  
| --- | --- | --- |  
| `old@example.com` | `new@example.com` | Письмо отправлено, требуется подтверждение |  
| `old@example.com` | `invalid` | Ошибка «Неверный формат email» |  
| `old@example.com` | `existing@example.com` | Ошибка «Email уже зарегистрирован» |

#### US-006: Выход из приложения [MVP]

**Примечание:** При выходе очищаются локальные кеши и токены, серверная сессия становится недействительной.

**Критерии приемки:**
- Пользователь может инициировать выход из меню профиля.
- После выхода серверная сессия закрыта, локальные данные авторизации удалены.
- Пользователь видит экран входа и для доступа требуется повторная авторизация.

**Сценарий:**  
_Дано_ пользователь авторизован.  
_Когда_ он открывает профиль и выбирает «Выйти».  
_Тогда_ приложение удаляет локальные токены, сервер закрывает сессию, отображается экран входа.

**Структура сценария:**  
1. Пользователь нажимает «Выйти».  
2. Клиент отправляет запрос на завершение сессии.  
3. Сервер инвалидирует токены.  
4. Клиент очищает локальные данные и открывает экран логина.

**Примеры:**  
| Ситуация | Результат |  
| --- | --- |  
| Пользователь нажал «Выйти» | Сессия удалена, отображается экран входа |  
| Пользователь повторно запускает приложение после выхода | Требуется ввод email и пароля |

#### US-040: Авторизация через Google [NOT MVP]
- **Как** пользователь
- **Я хочу** войти через аккаунт Google
- **Чтобы** быстро войти без пароля

#### US-041: Авторизация через Яндекс [NOT MVP]
- **Как** пользователь
- **Я хочу** войти через аккаунт Яндекс
- **Чтобы** быстро войти без пароля

---

## АКТИВНОСТЬ 2: Организовать умный дом

### Задача 2.1: Добавить устройство

#### US-010: Добавление устройства через QR-код [MVP]

**Примечание:** QR-код находится на упаковке устройства; модель определяется автоматически.

**Критерии приемки:**
- Пользователь может открыть камеру и отсканировать QR-код.
- Код должен содержать 12 цифр; невалидный код отклоняется.
- Система проверяет наличие устройства в базе.
- В доме не может быть более 100 устройств.
- После добавления пользователь выбирает комнату (опционально).
- Устройство получает название по модели.

**Сценарий 1: Успешное добавление**  
_Дано_ пользователь находится на экране «Добавить устройство».  
_Когда_ он выбирает «Сканировать QR-код», направляет камеру на валидный код и подтверждает добавление.  
_Тогда_ устройство добавляется в дом, отображается в списке устройств, предлагается выбрать комнату, устройство названо по модели.

**Сценарий 2: Невалидный QR**  
_Дано_ пользователь сканирует QR-код.  
_Когда_ код содержит символы вне 12-значного формата.  
_Тогда_ система показывает ошибку «Неверный код устройства», добавление отменяется.

**Сценарий 3: Превышение лимита**  
_Дано_ в доме уже 100 устройств.  
_Когда_ пользователь сканирует новый QR-код.  
_Тогда_ система сообщает «Максимум 100 устройств на дом» и не добавляет устройство.

**Структура сценария:**  
1. Пользователь начинает добавление устройства и запускает сканер.  
2. Сканирует QR-код, система валидирует формат и ищет устройство.  
3. При успехе устройство привязывается к дому, предлагается выбрать комнату.

**Примеры:**  
| QR-код | результат |  
| --- | --- |  
| `123456789012` | Устройство добавлено, предложен выбор комнаты |  
| `abc123` | Ошибка «Неверный код устройства» |  
| `123456789013` (при 100 устройствах) | Ошибка «Максимум 100 устройств на дом» |

#### US-011: Добавление устройства вручную [MVP]

**Примечание:** 12-значный код нанесён на упаковку; ручной ввод нужен, если QR-код повреждён.

**Критерии приемки:**
- Пользователь может выбрать ввод кода вручную.
- Код валидируется: только цифры, длина 12.
- Система проверяет, существует ли устройство.
- Дальнейший процесс идентичен добавлению через QR.

**Сценарий:**  
_Дано_ пользователь находится в мастере добавления устройства.  
_Когда_ он выбирает «Ввести код вручную», вводит валидный код и подтверждает.  
_Тогда_ система валидирует формат, находит устройство, добавляет его в дом и предлагает выбрать комнату.

**Структура сценария:**  
1. Пользователь переключается на ручной ввод.  
2. Вводит 12-значный код и нажимает «Добавить».  
3. Система проверяет формат и наличие устройства, завершает добавление.

**Примеры:**  
| код | результат |  
| --- | --- |  
| `123456789012` | Устройство добавлено аналогично QR-процессу |  
| `abc123` | Ошибка «Код должен содержать 12 цифр» |

#### US-012: Предотвращение дубликатов устройств [MVP]

**Примечание:** Проверка выполняется на уровне уникальности кода устройства внутри дома.

**Критерии приемки:**
- При добавлении система проверяет, есть ли устройство с этим кодом в текущем доме.
- Повторное добавление блокируется.
- Пользователь получает сообщение «Устройство уже добавлено в дом».
- В базе остаётся только одна запись устройства.

**Сценарий:**  
_Дано_ в доме уже есть устройство с кодом `123456789012`.  
_Когда_ пользователь повторно вводит этот код или сканирует тот же QR.  
_Тогда_ система сообщает «Устройство уже добавлено в дом» и не создаёт дубликат.

**Структура сценария:**  
1. На шаге добавления устройство идентифицируется по коду.  
2. Выполняется проверка уникальности в рамках дома.  
3. При совпадении возвращается ошибка и процесс завершается.

**Примеры:**  
| код | состояние | результат |  
| --- | --- | --- |  
| `123456789012` | устройство уже есть | Ошибка «Устройство уже добавлено в дом» |  
| `987654321098` | нового устройства в доме нет | Добавление продолжается |

### Задача 2.2: Настроить устройство

#### US-013: Привязка устройства к комнате [MVP]

**Примечание:** Комната не обязательна; устройство можно оставить без привязки и назначить позже.

**Критерии приемки:**
- Пользователь может открыть настройки устройства и выбрать комнату из списка существующих.
- Есть опция «Без комнаты».
- После сохранения устройство появляется в списке выбранной комнаты.

**Сценарий:**  
_Дано_ устройство уже добавлено в дом.  
_Когда_ пользователь выбирает «Настроить устройство», выбирает комнату и сохраняет.  
_Тогда_ устройство привязывается к комнате и отображается в соответствующем списке.

**Структура сценария:**  
1. Открыть карточку устройства.  
2. Нажать «Настроить устройство».  
3. Выбрать комнату (или оставить без комнаты).  
4. Сохранить изменения.

**Примеры:**  
| выбор комнаты | результат |  
| --- | --- |  
| «Спальня» | Устройство отображается в разделе «Спальня» |  
| «Без комнаты» | Устройство остаётся в общем списке без привязки |

#### US-014: Удаление устройства [MVP]

**Примечание:** Перед удалением показывается подтверждение; все настройки устройства удаляются без возможности восстановления.

**Критерии приемки:**
- В карточке устройства есть действие «Удалить устройство».
- Перед удалением требуется подтверждение.
- Устройство удаляется из дома и всех комнат.
- После удаления устройство исчезает из списков.

**Сценарий:**  
_Дано_ устройство «Лампочка в спальне» есть в доме.  
_Когда_ пользователь выбирает «Удалить устройство» и подтверждает действие.  
_Тогда_ устройство удаляется из дома, перестаёт отображаться в общих списках и комнатах.

**Структура сценария:**  
1. Открыть карточку устройства.  
2. Нажать «Удалить устройство».  
3. Подтвердить действие.  
4. Система удаляет устройство и обновляет интерфейс.

**Примеры:**  
| устройство | действие | результат |  
| --- | --- | --- |  
| «Лампочка в спальне» | Подтверждено удаление | Устройство удалено, не отображается |  
| «Розетка на кухне» | Нажато «Отмена» | Устройство остаётся |

#### US-043: Изменение названия устройства [NOT MVP]
- **Как** пользователь
- **Я хочу** изменять названия устройств
- **Чтобы** называть их по-своему

#### US-044: Удаление устройства из комнаты [MVP]

**Примечание:** Используется при перестановках — альтернатива прямому изменению комнаты.

**Критерии приемки:**
- В карточке устройства есть действие «Удалить из комнаты».
- После действия устройство остаётся в доме без привязки.
- Пользователь может затем назначить другую комнату.
- Требуется подтверждение.

**Сценарий:**  
_Дано_ устройство «Лампочка» привязано к комнате «Спальня».  
_Когда_ пользователь выбирает «Удалить из комнаты» и подтверждает.  
_Тогда_ устройство отвязывается от комнаты и отображается в списке устройств без привязки.

**Структура сценария:**  
1. Открыть устройство в конкретной комнате.  
2. Нажать «Удалить из комнаты».  
3. Подтвердить действие.  
4. Устройство остаётся в доме без комнаты.

**Примеры:**  
| устройство | исходная комната | результат |  
| --- | --- | --- |  
| «Лампочка» | «Спальня» | Устройство без комнаты, доступно для новой привязки |  
| «Умная розетка» | «Гостиная» (нажата «Отмена») | Устройство остаётся в «Гостиной» |

### Задача 2.3: Добавить комнату

#### US-007: Создание комнат [MVP]

**Примечание:** Комнаты необязательны — устройства можно добавлять и без них, но они помогают структурировать управление.

**Критерии приемки:**
- Пользователь может добавить комнату, указав тип, название и иконку.
- В одном доме можно создать не более 10 комнат.
- Название комнаты обязательно.
- Типы ограничены значениями: `living_room`, `bedroom`, `kitchen`, `bathroom`, `hallway`, `corridor`, `other`.
- После создания комната отображается на главном экране.

**Сценарий 1: Создание комнаты**  
_Дано_ пользователь находится на главном экране дома.  
_Когда_ он нажимает «Добавить комнату», выбирает тип «Спальня», задаёт название и иконку, подтверждает.  
_Тогда_ комната добавляется в дом и появляется в списке комнат.

**Сценарий 2: Превышение лимита**  
_Дано_ в доме уже 10 комнат.  
_Когда_ пользователь пытается создать ещё одну.  
_Тогда_ система показывает ошибку «Максимум 10 комнат на дом».

**Сценарий 3: Пустое название**  
_Дано_ пользователь в мастере создания комнаты.  
_Когда_ он оставляет поле названия пустым.  
_Тогда_ система отображает ошибку «Название обязательно».

**Структура сценария:**  
1. Запуск мастера создания комнаты.  
2. Ввод названия, выбор типа и иконки.  
3. Сохранение комнаты.  
4. Обновление списка комнат на главном экране.

**Примеры:**  
| название | тип | результат |  
| --- | --- | --- |  
| «Главная спальня» | `bedroom` | Комната создана, отображается на Dashboard |  
| _(пусто)_ | `kitchen` | Ошибка «Название обязательно» |  
| «Коридор» (11-я комната) | `hallway` | Ошибка «Максимум 10 комнат на дом» |

---

## АКТИВНОСТЬ 3: Управлять умным домом

### Задача 3.1: Управлять устройством

#### US-015: Включение/выключение устройства [MVP]

**Примечание:** Статус устройства синхронизируется с физическим прибором в реальном времени; при офлайн-состоянии статус обновится после восстановления связи.

**Критерии приемки:**
- Пользователь может включить или выключить устройство одним нажатием.
- Статус в интерфейсе соответствует реальному состоянию прибора.
- Время реакции устройства менее 2 секунд.
- Если устройство не отвечает, отображается статус «недоступно».
- В интерфейсе есть визуальный индикатор текущего статуса.

**Сценарий 1: Включение устройства**  
_Дано_ устройство «Лампочка» выключено.  
_Когда_ пользователь нажимает переключатель.  
_Тогда_ устройство включается, статус меняется на «включено», индикатор освещается.

**Сценарий 2: Устройство недоступно**  
_Дано_ устройство потеряло связь.  
_Когда_ пользователь пытается включить его.  
_Тогда_ система показывает статус «недоступно», команда не выполняется.

**Структура сценария:**  
1. Пользователь открывает список устройств.  
2. Нажимает на переключатель нужного устройства.  
3. Клиент отправляет команду; при успехе обновляет статус, при ошибке показывает «недоступно».

**Примеры:**  
| устройство | действие | результат |  
| --- | --- | --- |  
| «Лампочка» (онлайн) | Нажата кнопка «Включить» | Статус «включено», индикатор горит |  
| «Розетка» (офлайн) | Нажата кнопка «Выключить» | Статус «недоступно», команда не выполнена |

#### US-016: Управление режимом энергосбережения [MVP]

**Примечание:** Функция повышает энергоэффективность, но увеличивает время отклика до 5 секунд и доступна только для включённых устройств.

**Критерии приемки:**
- Пользователь может включить и выключить режим энергосбережения.
- Включить режим можно только для активного устройства.
- При активном режиме энергопотребление снижается, а время отклика увеличивается.
- В интерфейсе отображается индикатор режима.

**Сценарий 1: Включение энергосбережения**  
_Дано_ устройство «Лампочка» включено.  
_Когда_ пользователь нажимает «Энергосбережение».  
_Тогда_ режим активируется, отображается индикатор, устройство реагирует на команды медленнее, потребляет меньше энергии.

**Сценарий 2: Попытка включить на выключенном устройстве**  
_Дано_ устройство выключено.  
_Когда_ пользователь пытается включить энергосбережение.  
_Тогда_ система сообщает «Сначала включите устройство» и не активирует режим.

**Структура сценария:**  
1. Пользователь открывает карточку устройства.  
2. Нажимает переключатель режима энергосбережения.  
3. Система проверяет, включено ли устройство, и активирует/деактивирует режим, обновляя индикаторы.

**Примеры:**  
| устройство | состояние | действие | результат |  
| --- | --- | --- | --- |  
| «Лампочка» | Включена | Нажато «Энергосбережение» | Режим активирован, индикатор включён |  
| «Розетка» | Выключена | Нажато «Энергосбережение» | Ошибка «Сначала включите устройство» |

#### US-017: Управление всеми устройствами комнаты [MVP]

**Примечание:** Действует только на устройства выбранной комнаты; удобно для быстрого управления освещением.

**Критерии приемки:**
- На экране комнаты есть кнопки «Включить всё» и «Выключить всё».
- Команда отправляется всем устройствам комнаты одновременно, устройства вне комнаты не затрагиваются.
- После выполнения статусы устройств обновляются в интерфейсе.

**Сценарий 1: Включить все устройства**  
_Дано_ в комнате «Спальня» три устройства, одно из них выключено.  
_Когда_ пользователь нажимает «Включить всё».  
_Тогда_ все устройства комнаты переходят в состояние «включено», статусы обновляются.

**Сценарий 2: Выключить все устройства**  
_Дано_ все устройства комнаты включены.  
_Когда_ пользователь нажимает «Выключить всё».  
_Тогда_ устройства выключаются, статусы показывают «выключено».

**Структура сценария:**  
1. Пользователь открывает экран комнаты.  
2. Нажимает кнопку группового управления.  
3. Система отправляет команды всем устройствам комнаты, обновляет статусы.

**Примеры:**  
| комната | состояние до | действие | результат |  
| --- | --- | --- | --- |  
| «Спальня» (2 включены, 1 выключено) | смешанное | «Включить всё» | Все устройства включены |  
| «Гостиная» (все включены) | все включены | «Выключить всё» | Все устройства выключены |

#### US-045: Настройка яркости устройства [NOT MVP]
- **Как** пользователь
- **Я хочу** настраивать яркость лампочки
- **Чтобы** создавать комфортное освещение

#### US-046: Изменение цвета устройства [NOT MVP]
- **Как** пользователь
- **Я хочу** изменять цвет лампочки
- **Чтобы** создавать атмосферу или экспериментировать

### Задача 3.2: Управлять комнатой

#### US-008: Редактирование комнат [MVP]

**Примечание:** При редактировании название, тип и иконка обновляются без влияния на устройства внутри комнаты.

**Критерии приемки:**
- Пользователь может изменить название, тип и иконку комнаты.
- Изменения сохраняются и сразу отображаются в интерфейсе.
- Устройства остаются привязанными к комнате.

**Сценарий:**  
_Дано_ пользователь смотрит список комнат.  
_Когда_ он выбирает комнату, нажимает «Редактировать», меняет данные и сохраняет.  
_Тогда_ комната обновляется, устройства продолжают отображаться внутри неё.

**Структура сценария:**  
1. Открыть экран комнаты.  
2. Нажать «Редактировать».  
3. Внести изменения и сохранить.  
4. Проверить, что комната и устройства отображаются с новыми данными.

**Примеры:**  
| исходное название | новое название | результат |  
| --- | --- | --- |  
| «Спальня» | «Главная спальня» | Комната переименована, устройства сохранены |  
| «Кухня» | _(без изменений)_ | Нажата «Отмена», данные без изменений |

#### US-009: Удаление комнат [MVP]

**Примечание:** Комнаты с устройствами нельзя удалить, пока устройства не перенесены.

**Критерии приемки:**
- Пустую комнату можно удалить после подтверждения.
- При попытке удалить комнату с устройствами система предупреждает и блокирует действие.
- Пользователь получает понятное сообщение о необходимости перенести устройства.

**Сценарий 1: Удаление пустой комнаты**  
_Дано_ комната «Коридор» не содержит устройств.  
_Когда_ пользователь выбирает «Удалить комнату» и подтверждает.  
_Тогда_ комната удаляется из списка.

**Сценарий 2: Удаление комнаты с устройствами**  
_Дано_ комната «Спальня» содержит устройства.  
_Когда_ пользователь пытается удалить комнату.  
_Тогда_ система показывает предупреждение «В комнате есть устройства. Сначала переместите их в другие комнаты», удаление отменяется.

**Структура сценария:**  
1. Пользователь открывает настройки комнаты.  
2. Нажимает «Удалить».  
3. Система проверяет наличие устройств.  
4. При необходимости отменяет удаление и показывает предупреждение.

**Примеры:**  
| комната | устройства | результат |  
| --- | --- | --- |  
| «Коридор» | 0 | Комната удалена |  
| «Спальня» | 3 | Предупреждение, удалить нельзя |

### Задача 3.3: Управлять автоматизацией

#### US-018: Создание сценария [MVP]
**Примечание:** Сценарии — ключевое конкурентное преимущество и востребованы продвинутыми пользователями.

**Критерии приемки:**
- Пользователь может создать сценарий, задав уникальное название (до 30 символов).
- В сценарий можно добавить несколько устройств и выбрать для каждого действие (включить/выключить).
- В одном доме допустимо не более 10 сценариев.
- После сохранения сценарий появляется в списке сценариев.

**Сценарий 1: Создание сценария «Утро»**  
_Дано_ пользователь находится на экране «Сценарии».  
_Когда_ он нажимает «Создать сценарий», вводит название «Утренний свет», выбирает устройства «Лампочка в спальне» и «Лампочка в ванной», устанавливает действие «включить» и сохраняет.  
_Тогда_ сценарий создаётся и отображается в общем списке.

**Сценарий 2: Превышение лимита сценариев**  
_Дано_ в доме уже создано 10 сценариев.  
_Когда_ пользователь пытается сохранить ещё один сценарий.  
_Тогда_ система выводит сообщение «Максимум 10 сценариев на дом», сценарий не создаётся.

**Сценарий 3: Слишком длинное название**  
_Дано_ пользователь вводит название длиннее 30 символов.  
_Когда_ он пытается сохранить сценарий.  
_Тогда_ система показывает ошибку «Название должно быть не более 30 символов».

**Структура сценария:**  
1. Открыть экран «Сценарии» и нажать «Создать сценарий».  
2. Ввести название (до 30 символов).  
3. Выбрать устройства и задать действия.  
4. Сохранить сценарий → он появляется в списке, если не превышен лимит.

**Примеры:**  
| название | устройства | результат |  
| --- | --- | --- |  
| «Утренний свет» | 2 устройства, действия «включить» | Сценарий создан |  
| «Очень длинное название сценария, не поместившееся» | 1 устройство | Ошибка «Название должно быть не более 30 символов» |  
| «Вечер» (11-й сценарий) | 3 устройства | Ошибка «Максимум 10 сценариев на дом» |

#### US-019: Ручной запуск сценария [MVP]

**Примечание:** Кнопка запуска расположена на карточке сценария; позволяет быстро воспроизвести набор действий.

**Критерии приемки:**
- Пользователь может вручную запустить сценарий нажатием кнопки.
- Все устройства сценария выполняют заданные действия в порядке `execution_order`.
- В интерфейсе отображается статус выполнения.
- Недоступные устройства пропускаются, остальные продолжают работу.

**Сценарий 1: Успешный запуск**  
_Дано_ сценарий «Утренний свет» создан и содержит несколько устройств.  
_Когда_ пользователь нажимает кнопку запуска на карточке сценария.  
_Тогда_ устройства выполняют свои действия по порядку, интерфейс показывает статус «Сценарий выполнен».

**Сценарий 2: Недоступное устройство**  
_Дано_ одно из устройств сценария недоступно.  
_Когда_ пользователь запускает сценарий.  
_Тогда_ недоступное устройство пропускается, остальные устройства выполняют действия; отображается предупреждение о пропущенном устройстве.

**Структура сценария:**  
1. Открыть список сценариев.  
2. Нажать кнопку запуска на нужном сценарии.  
3. Система выполняет действия устройств по порядку, обновляет статус.

**Примеры:**  
| сценарий | устройства | результат |  
| --- | --- | --- |  
| «Утренний свет» | 3 доступных устройства | Все включены, статус «Сценарий выполнен» |  
| «Вечер» | 2 устройства (1 недоступно) | Доступное устройство выключено, показано предупреждение |

**Примечания:**
- Кнопка запуска на главном экране сценариев
- Удобно для быстрого управления

#### US-020: Настройка расписания сценария [MVP]

**Примечание:** Пошаговый мастер позволяет выбрать дни и время; время окончания опционально, но востребовано заказчиком.

**Критерии приемки:**
- Пользователь может включить расписание и выбрать дни недели запуска.
- Можно задать время запуска сценария.
- Необязательно, но доступно время окончания; если не заполнять, сценарий только запускается.
- При отсутствии расписания сценарий запускается вручную.
- В выбранные дни сценарий стартует автоматически в заданное время.

**Сценарий 1: Настройка расписания**  
_Дано_ сценарий «Утренний свет» создан.  
_Когда_ пользователь открывает «Настроить расписание», выбирает дни «Пн–Пт», задаёт время начала «07:00» и время окончания «08:00», сохраняет.  
_Тогда_ сценарий автоматически запускается в 07:00 в будни и выключает устройства в 08:00.

**Сценарий 2: Только ручной запуск**  
_Дано_ пользователь оставляет расписание выключенным.  
_Когда_ он сохраняет настройки.  
_Тогда_ сценарий доступен только для ручного запуска.

**Структура сценария:**  
1. Открыть карточку сценария → «Настроить расписание».  
2. Включить расписание, выбрать дни и время (при необходимости время окончания).  
3. Сохранить изменения.  
4. Планировщик запускает сценарий согласно настройкам.

**Примеры:**  
| дни | время начала | время окончания | результат |  
| --- | --- | --- | --- |  
| Пн–Пт | 07:00 | 08:00 | Сценарий запускается в 07:00, выключается в 08:00 |  
| — | — | — | Сценарий доступен только вручную |

**Примечания:**
- Пошаговая настройка расписания
- Время окончания - востребованная функция по данным заказчика

#### US-021: Удаление сценария [MVP]

**Примечание:** Перед удалением требуется подтверждение; история выполнения может сохраняться для аналитики.

**Критерии приемки:**
- Пользователь может удалить сценарий из списка.
- Перед удалением показывается диалог подтверждения.
- После удаления сценарий исчезает из списка и больше не запускается автоматически.

**Сценарий:**  
_Дано_ существует сценарий «Старый сценарий».  
_Когда_ пользователь выбирает «Удалить сценарий» и подтверждает действие.  
_Тогда_ сценарий удаляется из базы, пропадает из списка и не запускается автоматически.

**Структура сценария:**  
1. Открыть список сценариев.  
2. Выбрать сценарий → «Удалить».  
3. Подтвердить действие.  
4. Система удаляет сценарий и обновляет интерфейс.

**Примеры:**  
| сценарий | результат |  
| --- | --- |  
| «Старый сценарий» | Удалён, больше не отображается |  
| «Вечерний режим» (нажата «Отмена») | Остаётся в списке |

#### US-048: Редактирование сценария [NOT MVP]
- **Как** пользователь
- **Я хочу** редактировать существующий сценарий
- **Чтобы** изменять действия и расписание

#### US-049: Создание сценария по таймеру [NOT MVP]
- **Как** пользователь
- **Я хочу** создавать сценарии с таймером
- **Чтобы** отключать устройства через заданное время

---

## Итоговая статистика

### MVP (MUST HAVE)
- **Всего историй:** 22
- **Все с Gherkin-сценариями**
- **Все с критериями приемки, примерами и примечаниями**

### Будущие версии (SHOULD HAVE / COULD HAVE)
- **Всего историй:** 15
- **Без Gherkin-сценариев** (пока не в разработке)

### Общая статистика
- **Всего пользовательских историй:** 37
- **Активностей:** 3
- **Пользовательских задач:** 8
- **Gherkin-сценариев для MVP:** 60+

### Детализация MVP историй
- **Войти в приложение:** 6 историй
- **Организовать умный дом:** 9 историй
- **Управлять умным домом:** 7 историй

---

## Критерии готовности (Definition of Done)

Для каждой пользовательской истории MVP:
1. ✅ Функциональность реализована согласно Gherkin-сценариям
2. ✅ Все сценарии проходят автоматические тесты
3. ✅ UI соответствует дизайн-системе Stets
4. ✅ Обработаны все edge cases и ошибки
5. ✅ Функция протестирована на обеих персонах (Михаил и Алёна)
6. ✅ Производительность соответствует требованиям (< 2 сек отклик)
7. ✅ Документация обновлена

---

## Метрики успеха MVP

- **Время онбординга:** < 5 минут от установки до первого управляемого устройства
- **Успешность добавления устройства:** > 95% через QR-код, > 90% через ручной ввод
- **Время отклика устройства:** < 2 секунды в обычном режиме, < 5 секунд в энергосбережении
- **Удовлетворенность пользователей:** > 4.0/5.0 в опросе после использования MVP

---

*Документ включает все пользовательские истории, определенные на основе интервью с заказчиком и пользователями, с четким разделением на MVP и будущие версии. Структура организована по трем базовым активностям согласно требованиям ревьюера.*
