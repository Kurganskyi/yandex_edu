# Сравнение словарей данных

## Контекст

Сравнение нашего словаря данных с альтернативной версией для выявления различий в подходе к моделированию данных приложения Stets Home.

---

## Ключевые различия

### 1. Архитектурный подход

**Наша модель** (Нормализованная, 3НФ):
- Выделены справочники: ICON, DEVICE_MODEL
- Связующие таблицы для M:N связей
- Устранены транзитивные зависимости
- Минимум дублирования данных

**Другая модель** (Менее нормализованная):
- Справочники выделены, но структура менее строгая
- Более плоская структура
- Потенциальные избыточности

### 2. Пользователь (USER)

#### Наша модель:
| Атрибут | Тип | Описание |
|---------|-----|----------|
| user_id | INT | PRIMARY KEY, AUTO_INCREMENT |
| email | VARCHAR(255) | UNIQUE, NOT NULL |
| password_hash | VARCHAR(60) | bcrypt hash |
| name | VARCHAR(100) | NOT NULL |
| created_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP |
| updated_at | TIMESTAMP | NOT NULL, DEFAULT CURRENT_TIMESTAMP ON UPDATE |

#### Другая модель:
- **email**: VARCHAR(100) — длина отличается
- **password** — хранится как строка, без уточнения хэширования
- Нет временных меток (created_at, updated_at)

**Вывод:** Наша модель более безопасна (хэширование паролей явно указано) и содержит временные метки для аудита.

### 3. Дом (HOME)

#### Наша модель:
| Атрибут | Тип | Описание |
|---------|-----|----------|
| home_id | INT | PRIMARY KEY |
| name | VARCHAR(100) | DEFAULT 'Мой дом' |
| created_at | TIMESTAMP | NOT NULL |

#### Другая модель:
- **Код дома**: INT(12) — синтетический ключ
- **Название дома**: VARCHAR(30) — короче
- Включает вложенные ограничения: 1:10 {комнат}, 1:10 {сценариев}, 1:100 {устройств}

**Вывод:** Наша модель проще и гибче. Ограничения вынесены в логику приложения, а не в схему БД.

### 4. Иконки и типы комнат

#### Наша модель:
- **ICON** - справочник иконок с URL и категорией
- **ROOM.type** - ENUM с предопределенными типами
- Отдельная таблица ICON со ссылкой на URL

#### Другая модель:
- **Тип комнаты** - отдельная таблица с иллюстрацией как файлом
- Более сложная структура справочников

**Вывод:** Наша модель использует URL для иконок (лучше для веб/мобильных приложений), другая - файлы (архаичный подход).

### 5. Устройства (DEVICE) — КРИТИЧЕСКОЕ РАЗЛИЧИЕ

#### Наша модель:
```sql
DEVICE {
  device_id INT PK
  device_code CHAR(12) UK
  model_id FK → DEVICE_MODEL
  home_id FK
  room_id FK (NULL)
  custom_name VARCHAR(100) NULL
  status ENUM('on','off','unavailable')
  energy_saving_mode BOOLEAN
  added_at TIMESTAMP
  last_seen TIMESTAMP
}
```

#### Другая модель:
```sql
DEVICE {
  ID устройства CHAR(12) PK
  Код модели устройства VARCHAR(25)
  Код дома FK
  Код комнаты FK
  Название устройства VARCHAR(30)
  Статус устройства VARCHAR(10)
  Статус режима энергосбережения VARCHAR(10)
  ⚠️ Цвет VARCHAR(25)
  ⚠️ Яркость INT(25)
}
```

**КРИТИЧЕСКОЕ РАЗЛИЧИЕ:**
- Наша модель: Цвет и яркость НЕ включены в MVP (по требованиям)
- Другая модель: Включает цвет и яркость в основные атрибуты

**Обоснование нашей модели:**
- Анализ требований показал: яркость/цвет — **COULD HAVE**, не в MVP
- Возможности устройства хранятся в **DEVICE_MODEL.capabilities** (JSON)
- Это позволяет расширять функциональность без изменения схемы БД

### 6. Модель устройства

#### Наша модель:
```sql
DEVICE_MODEL {
  model_id INT PK
  model_name VARCHAR(100) UK
  device_type ENUM('bulb','socket')
  capabilities JSON  // {"brightness": true, "color": true}
  description TEXT
}
```

#### Другая модель:
- Отдельные таблицы: Модель устройства, Тип устройства
- Более денормализованная структура

**Вывод:** Наша модель более гибкая за счет JSON capabilities — легко добавлять новые возможности устройства без изменения схемы.

### 7. Сценарии автоматизации

#### Наша модель:
```sql
SCENARIO {
  scenario_id INT PK
  home_id FK
  name VARCHAR(30)
  created_at TIMESTAMP
  updated_at TIMESTAMP
}

SCENARIO_SCHEDULE {
  schedule_id INT PK
  scenario_id FK
  monday BOOLEAN
  tuesday BOOLEAN
  ...
  start_time TIME
  end_time TIME
}

SCENARIO_ACTION {
  action_id INT PK
  scenario_id FK
  device_id FK
  action_type ENUM('turn_on','turn_off')
  execution_order INT
}
```

#### Другая модель:
```sql
Сценарий {
  Код сценария INT(12) PK
  Тип запуска VARCHAR(30)  // ручной/автоматический
  Время запуска TIME
  Дни недели
  Статус сценария VARCHAR(10)
}

Сценарий-устройство {
  Код сценария FK
  ID устройства FK
  Статус устройства
}

День недели в сценарии {
  Код сценария FK
  Код дня недели FK
  Код дома FK
}

День недели {
  Код дня недели INT(12) PK
  Название VARCHAR(15)
}
```

**КРИТИЧЕСКИЕ РАЗЛИЧИЯ:**

1. **Тип запуска** - Наша модель: опциональное расписание (start_time NULL = ручной)
   - Другая модель: явное поле "Тип запуска"

2. **Дни недели** - Наша модель: 7 boolean полей в SCENARIO_SCHEDULE
   - Другая модель: отдельная таблица День недели + связующая таблица
   - Вывод: Наша модель проще и эффективнее

3. **Статус сценария** - Другая модель включает состояния "включен/завершен/недоступен"
   - Наша модель: статус не нужен для MVP (сценарий либо выполняется, либо нет)
   - Вывод: Другая модель закладывает логику выполнения, наша - проще

4. **Порядок выполнения** - Наша модель: execution_order в SCENARIO_ACTION
   - Другая модель: нет порядка
   - Вывод: Критично для корректного выполнения сложных сценариев

5. **Тип действия** - Наша модель: ENUM('turn_on','turn_off')
   - Другая модель: использует статус устройства (некорректно)
   - Вывод: Наша модель правильнее - действие отличается от состояния

### 8. Новые сущности в другой модели

#### Код подтверждения (отсутствует в нашей модели):
```sql
КОД ПОДТВЕРЖДЕНИЯ {
  Код INT(12) PK
  Тип кода VARCHAR(30)  // восстановление пароля/замена email
  Email (новая) VARCHAR(100)
  Дата создания DATETIME
  Дата истечения DATETIME
}
```

**Оценка:**
- Полезная сущность для восстановления пароля и смены email
- В нашей модели это может быть реализовано через отдельную таблицу или токены в сессии
- Рекомендация: добавить в будущих версиях

---

## Сравнительная таблица

| Аспект | Наша модель | Другая модель | Преимущество |
|--------|-------------|---------------|--------------|
| **Нормализация** | 3НФ, минимальная избыточность | Частичная нормализация | ✅ Наша |
| **Безопасность паролей** | Явное хэширование (bcrypt) | Не указано | ✅ Наша |
| **Временные метки** | created_at, updated_at везде | Отсутствуют | ✅ Наша |
| **Иконки** | URL в БД | Файлы | ✅ Наша |
| **Цвет/Яркость** | В capabilities JSON, не в MVP | Прямые поля в DEVICE | ⚠️ Конфликт с требованиями |
| **Расписания** | 7 boolean + время | Отдельные таблицы | ✅ Наша (проще) |
| **Порядок действий** | execution_order | Нет | ✅ Наша |
| **Статус сценария** | Не нужен для MVP | Есть | 🤔 Зависит от требований |
| **Код подтверждения** | Не реализовано | Есть отдельная таблица | ✅ Другая (полезно) |
| **Capabilities устройства** | JSON в DEVICE_MODEL | Не реализовано | ✅ Наша (гибкость) |
| **Лимиты** | В логике приложения | В описании схемы | ✅ Наша (гибкость БД) |

---

## Выводы и рекомендации

### ✅ Преимущества нашей модели

1. **Соответствие требованиям MVP** - цвет и яркость вынесены из основной модели
2. **Гибкость** - JSON capabilities позволяет расширять без изменения схемы
3. **Безопасность** - явное указание хэширования паролей
4. **Производительность** - эффективная структура расписаний (7 boolean)
5. **Простота** - меньше таблиц, меньше JOIN операций
6. **Нормализация** - минимум избыточности, лучше целостность данных

### ⚠️ Что стоит улучшить в нашей модели

1. **Код подтверждения** - добавить таблицу для токенов восстановления пароля
2. **Статус выполнения сценария** - рассмотреть для будущих версий
3. **Таблица для настроек пользователя** - если потребуются персональные настройки

### ❌ Критические проблемы другой модели

1. **Цвет и яркость в MVP** - противоречит требованиям (COULD HAVE, не MUST)
2. **Отсутствие хэширования паролей** - проблема безопасности
3. **Избыточная сложность** - отдельная таблица для дней недели
4. **Отсутствие execution_order** - сценарии могут выполняться неправильно
5. **Некорректная связь** - SCENARIO_ACTION использует статус вместо действия

---

## Сравнение DFD диаграмм

Помимо модели данных, было проведено сравнение диаграмм потоков данных (DFD Level 1). Подробный анализ см. [`comparison_dfd.md`](./comparison_dfd.md).

### Краткое резюме:
- **Наша модель**: 6 процессов, 10 хранилищ, отдельный процесс IoT-синхронизации
- **Другая модель**: 6 процессов, 5 хранилищ, нет отдельного процесса IoT
- **Преимущество нашей модели**: Лучшая нормализация, поддержка участников дома, разделение IoT-синхронизации

## Рекомендации

Наша модель **лучше подходит для MVP**, так как:
- Строго соответствует приоритизации MoSCoW
- Учитывает ограничения MVP
- Более гибкая и масштабируемая
- Соответствует современным практикам БД
- Учитывает безопасность (хэширование паролей)
- Лучшая архитектура процессов в DFD

Дополнительные таблицы из другой модели (Код подтверждения) можно добавить в следующих версиях при необходимости, но основная архитектура должна остаться как в нашей модели.

---

*Сравнение выполнено на основе анализа требований, ER-диаграмм, словарей данных и DFD диаграмм обеих моделей.*
